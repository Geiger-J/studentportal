<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Bromsgrove Student Portal</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div th:replace="fragments/header :: header"></div>

    <main class="main-content">
        <div class="container">
            <div class="profile-container">
                <h1>Complete Your Profile</h1>
                <p class="form-subtitle">Please complete your academic profile to access the portal features</p>

                <div th:if="${message}" class="alert alert-success" th:text="${message}"></div>
                <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

                <form action="/profile" method="post" class="form profile-form">

                    <section class="form-section">
                        <h2>Personal Information</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Full Name</label>
                                <input type="text" class="form-input" th:value="${user.fullName}" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-input" th:value="${user.email}" readonly>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Role</label>
                                <input type="text" class="form-input" th:value="${user.role.displayName}" readonly>
                            </div>
                        </div>
                    </section>

                    <!-- Academic sections (only for STUDENT users) -->
                    <div th:if="${user.role.name() == 'STUDENT'}">
                        <section class="form-section">
                            <h2>Academic Information</h2>

                        <div class="form-group">
                            <label for="yearGroup" class="form-label">Year Group *</label>
                            <select id="yearGroup" name="yearGroup" class="form-select" required>
                                <option value="">Select your year group</option>
                                <option value="9" th:selected="${user.yearGroup == 9}">Year 9</option>
                                <option value="10" th:selected="${user.yearGroup == 10}">Year 10</option>
                                <option value="11" th:selected="${user.yearGroup == 11}">Year 11</option>
                                <option value="12" th:selected="${user.yearGroup == 12}">Year 12</option>
                                <option value="13" th:selected="${user.yearGroup == 13}">Year 13</option>
                            </select>
                            <small class="form-help">Required for profile completion</small>
                        </div>

                        <div class="form-group" id="examBoardGroup">
                            <label for="examBoard" class="form-label">Exam Board</label>
                            <select id="examBoard" name="examBoard" class="form-select">
                                <option value="">Select exam board</option>
                                <option value="GCSE" th:selected="${user.examBoard?.name() == 'GCSE'}">GCSE</option>
                                <option value="A_LEVELS" th:selected="${user.examBoard?.name() == 'A_LEVELS'}">A Levels</option>
                                <option value="IB" th:selected="${user.examBoard?.name() == 'IB'}">International Baccalaureate</option>
                            </select>
                            <small class="form-help">Automatically set for Years 9-11 (GCSE). Choose for Years 12-13.</small>
                        </div>
                    </section>

                    <section class="form-section">
                        <h2>Subjects *</h2>
                        <p class="section-description">Select the subjects you're studying or can help with:</p>
                        <div class="subject-groups">
                            <div th:each="group : ${subjectGroups}" class="subject-group">
                                <h3 th:text="${group.key}">Subject Group</h3>
                                <div class="subject-cards">
                                    <div th:each="subject : ${group.value}" 
                                         class="subject-card"
                                         th:classappend="${user.subjects != null and user.subjects.contains(subject)} ? 'selected' : ''"
                                         onclick="toggleSubject(this)">
                                        <input type="checkbox"
                                               th:id="${'subject_' + subject.id}"
                                               name="subjectIds"
                                               th:value="${subject.id}"
                                               th:checked="${user.subjects != null and user.subjects.contains(subject)}">
                                        <div class="subject-name" th:text="${subject.displayName}">Subject Name</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <small class="form-help">Select at least one subject to complete your profile</small>
                    </section>

                    <section class="form-section">
                        <h2>Availability *</h2>
                        <p class="section-description">Select when you're available for tutoring sessions:</p>
                        <table class="timeslot-table">
                            <thead>
                                <tr>
                                    <th>Period</th>
                                    <th>Monday</th>
                                    <th>Tuesday</th>
                                    <th>Wednesday</th>
                                    <th>Thursday</th>
                                    <th>Friday</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="period-label">P1 (09:00-09:50)</td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).MON_P1)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="MON_P1" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).MON_P1)}">
                                    </td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).TUE_P1)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="TUE_P1" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).TUE_P1)}">
                                    </td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).WED_P1)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="WED_P1" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).WED_P1)}">
                                    </td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).THU_P1)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="THU_P1" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).THU_P1)}">
                                    </td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).FRI_P1)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="FRI_P1" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).FRI_P1)}">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="period-label">P2 (09:55-10:45)</td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).MON_P2)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="MON_P2" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).MON_P2)}">
                                    </td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).TUE_P2)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="TUE_P2" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).TUE_P2)}">
                                    </td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).WED_P2)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="WED_P2" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).WED_P2)}">
                                    </td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).THU_P2)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="THU_P2" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).THU_P2)}">
                                    </td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).FRI_P2)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="FRI_P2" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).FRI_P2)}">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="period-label">P3 (11:05-11:55)</td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).MON_P3)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="MON_P3" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).MON_P3)}">
                                    </td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).TUE_P3)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="TUE_P3" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).TUE_P3)}">
                                    </td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).WED_P3)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="WED_P3" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).WED_P3)}">
                                    </td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).THU_P3)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="THU_P3" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).THU_P3)}">
                                    </td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).FRI_P3)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="FRI_P3" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).FRI_P3)}">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="period-label">P4 (12:00-12:50)</td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).MON_P4)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="MON_P4" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).MON_P4)}">
                                    </td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).TUE_P4)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="TUE_P4" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).TUE_P4)}">
                                    </td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).WED_P4)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="WED_P4" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).WED_P4)}">
                                    </td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).THU_P4)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="THU_P4" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).THU_P4)}">
                                    </td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).FRI_P4)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="FRI_P4" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).FRI_P4)}">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="period-label">P5 (14:05-14:55)</td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).MON_P5)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="MON_P5" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).MON_P5)}">
                                    </td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).TUE_P5)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="TUE_P5" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).TUE_P5)}">
                                    </td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).WED_P5)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="WED_P5" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).WED_P5)}">
                                    </td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).THU_P5)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="THU_P5" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).THU_P5)}">
                                    </td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).FRI_P5)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="FRI_P5" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).FRI_P5)}">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="period-label">P6 (15:00-15:50)</td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).MON_P6)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="MON_P6" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).MON_P6)}">
                                    </td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).TUE_P6)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="TUE_P6" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).TUE_P6)}">
                                    </td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).WED_P6)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="WED_P6" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).WED_P6)}">
                                    </td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).THU_P6)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="THU_P6" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).THU_P6)}">
                                    </td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).FRI_P6)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="FRI_P6" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).FRI_P6)}">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="period-label">P7 (16:00-17:15)</td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).MON_P7)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="MON_P7" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).MON_P7)}">
                                    </td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).TUE_P7)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="TUE_P7" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).TUE_P7)}">
                                    </td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).WED_P7)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="WED_P7" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).WED_P7)}">
                                    </td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).THU_P7)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="THU_P7" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).THU_P7)}">
                                    </td>
                                    <td class="timeslot-cell" th:classappend="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).FRI_P7)} ? 'selected' : ''" onclick="toggleTimeslot(this)">
                                        <input type="checkbox" name="timeslots" value="FRI_P7" th:checked="${user.availability != null and user.availability.contains(T(com.example.studentportal.model.Timeslot).FRI_P7)}">
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <small class="form-help">Select at least one time slot to complete your profile</small>
                    </section>
                    </div>
                    <!-- End of academic sections for STUDENT users -->

                    <section class="form-section">
                        <h2>Tutoring Preferences</h2>
                        <div class="form-group">
                            <label for="maxTutoringPerWeek" class="form-label">Maximum Tutoring Sessions Per Week</label>
                            <input type="number" id="maxTutoringPerWeek" name="maxTutoringPerWeek"
                                   class="form-input" min="0" max="20"
                                   th:value="${user.maxTutoringPerWeek ?: 0}">
                            <small class="form-help">How many tutoring sessions (giving or receiving) you want per week (0 = no limit)</small>
                        </div>
                    </section>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary btn-large">Save Profile</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <div th:replace="fragments/footer :: footer"></div>

    <script>
        document.getElementById('yearGroup').addEventListener('change', function() {
            const yearGroup = parseInt(this.value);
            const examBoardSelect = document.getElementById('examBoard');
            const examBoardGroup = document.getElementById('examBoardGroup');

            if (yearGroup >= 9 && yearGroup <= 11) {
                examBoardSelect.value = 'GCSE';
                examBoardSelect.disabled = true;
                examBoardGroup.querySelector('.form-help').textContent = 'Automatically set to GCSE for Years 9-11';
            } else if (yearGroup >= 12 && yearGroup <= 13) {
                examBoardSelect.disabled = false;
                examBoardGroup.querySelector('.form-help').textContent = 'Choose between A Levels or IB for Years 12-13';
            } else {
                examBoardSelect.value = '';
                examBoardSelect.disabled = true;
                examBoardGroup.querySelector('.form-help').textContent = 'Select a valid year group';
            }
        });

        // Subject card toggle functionality
        function toggleSubject(card) {
            const checkbox = card.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            card.classList.toggle('selected', checkbox.checked);
        }

        // Timeslot cell toggle functionality
        function toggleTimeslot(cell) {
            const checkbox = cell.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            cell.classList.toggle('selected', checkbox.checked);
        }

        // Initialize selected states on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial state for subject cards
            document.querySelectorAll('.subject-card').forEach(card => {
                const checkbox = card.querySelector('input[type="checkbox"]');
                if (checkbox && checkbox.checked) {
                    card.classList.add('selected');
                }
            });

            // Set initial state for timeslot cells
            document.querySelectorAll('.timeslot-cell').forEach(cell => {
                const checkbox = cell.querySelector('input[type="checkbox"]');
                if (checkbox && checkbox.checked) {
                    cell.classList.add('selected');
                }
            });
        });
    </script>
</body>
</html>